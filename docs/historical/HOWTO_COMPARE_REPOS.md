# How to Compare createrepo_c vs yums3 Output

Now that storage backends are implemented, you can easily compare the metadata generated by createrepo_c versus yums3 using local storage.

## Quick Comparison Script

```bash
#!/bin/bash
# compare_repos.sh - Compare createrepo_c vs yums3 metadata

set -e

# Setup directories
WORK_DIR="/tmp/repo_comparison"
CREATEREPO_DIR="$WORK_DIR/createrepo"
YUMS3_DIR="$WORK_DIR/yums3"

rm -rf "$WORK_DIR"
mkdir -p "$CREATEREPO_DIR" "$YUMS3_DIR"

# Copy test RPMs to both directories
cp test_rpms/*.rpm "$CREATEREPO_DIR/"
cp test_rpms/*.rpm "$YUMS3_DIR/"

echo "=== Creating repository with createrepo_c ==="
createrepo_c "$CREATEREPO_DIR"

echo ""
echo "=== Creating repository with yums3 ==="
# Create config for local storage
cat > /tmp/yums3_compare.conf <<EOF
{
  "storage_type": "local",
  "local_storage_path": "$YUMS3_DIR",
  "local_repo_base": "/tmp/yums3_compare_cache"
}
EOF

# Add packages using yums3
python3 yums3.py --config /tmp/yums3_compare.conf -y "$YUMS3_DIR"/*.rpm

echo ""
echo "=== Comparing metadata files ==="

# Compare repomd.xml
echo "--- repomd.xml ---"
diff -u "$CREATEREPO_DIR/repodata/repomd.xml" "$YUMS3_DIR/el9/x86_64/repodata/repomd.xml" || true

# List all metadata files
echo ""
echo "--- createrepo_c files ---"
ls -lh "$CREATEREPO_DIR/repodata/"

echo ""
echo "--- yums3 files ---"
ls -lh "$YUMS3_DIR/el9/x86_64/repodata/"

# Compare primary.xml (decompressed)
echo ""
echo "--- Comparing primary.xml ---"
gunzip -c "$CREATEREPO_DIR/repodata/"*-primary.xml.gz > /tmp/createrepo_primary.xml
gunzip -c "$YUMS3_DIR/el9/x86_64/repodata/"*-primary.xml.gz > /tmp/yums3_primary.xml
diff -u /tmp/createrepo_primary.xml /tmp/yums3_primary.xml || true

# Compare filelists.xml (decompressed)
echo ""
echo "--- Comparing filelists.xml ---"
gunzip -c "$CREATEREPO_DIR/repodata/"*-filelists.xml.gz > /tmp/createrepo_filelists.xml
gunzip -c "$YUMS3_DIR/el9/x86_64/repodata/"*-filelists.xml.gz > /tmp/yums3_filelists.xml
diff -u /tmp/createrepo_filelists.xml /tmp/yums3_filelists.xml || true

# Compare other.xml (decompressed)
echo ""
echo "--- Comparing other.xml ---"
gunzip -c "$CREATEREPO_DIR/repodata/"*-other.xml.gz > /tmp/createrepo_other.xml
gunzip -c "$YUMS3_DIR/el9/x86_64/repodata/"*-other.xml.gz > /tmp/yums3_other.xml
diff -u /tmp/createrepo_other.xml /tmp/yums3_other.xml || true

echo ""
echo "=== Testing with DNF ==="

# Test createrepo_c version
echo "--- Testing createrepo_c repo ---"
dnf repoquery --repofrompath=test_createrepo,"$CREATEREPO_DIR" --repo=test_createrepo --disablerepo='*' -a 2>&1 || true

# Test yums3 version
echo ""
echo "--- Testing yums3 repo ---"
dnf repoquery --repofrompath=test_yums3,"$YUMS3_DIR/el9/x86_64" --repo=test_yums3 --disablerepo='*' -a 2>&1 || true

echo ""
echo "=== Comparison complete ==="
echo "Directories:"
echo "  createrepo_c: $CREATEREPO_DIR"
echo "  yums3:        $YUMS3_DIR/el9/x86_64"
```

## Manual Step-by-Step Comparison

### 1. Create createrepo_c Repository

```bash
mkdir -p /tmp/compare/createrepo
cp test_rpms/*.rpm /tmp/compare/createrepo/
createrepo_c /tmp/compare/createrepo
```

### 2. Create yums3 Repository

```bash
# Create config
cat > /tmp/yums3_local.conf <<EOF
{
  "storage_type": "local",
  "local_storage_path": "/tmp/compare/yums3",
  "local_repo_base": "/tmp/compare/cache"
}
EOF

# Add packages
python3 yums3.py --config /tmp/yums3_local.conf -y /tmp/compare/yums3/*.rpm
```

Note: yums3 will create the structure at `/tmp/compare/yums3/el9/x86_64/`

### 3. Compare Metadata Files

```bash
# Compare repomd.xml
diff -u /tmp/compare/createrepo/repodata/repomd.xml \
        /tmp/compare/yums3/el9/x86_64/repodata/repomd.xml

# Compare primary.xml (decompressed)
gunzip -c /tmp/compare/createrepo/repodata/*-primary.xml.gz > /tmp/createrepo_primary.xml
gunzip -c /tmp/compare/yums3/el9/x86_64/repodata/*-primary.xml.gz > /tmp/yums3_primary.xml
diff -u /tmp/createrepo_primary.xml /tmp/yums3_primary.xml

# Compare SQLite databases
bunzip2 -c /tmp/compare/createrepo/repodata/*-primary.sqlite.bz2 > /tmp/createrepo_primary.sqlite
bunzip2 -c /tmp/compare/yums3/el9/x86_64/repodata/*-primary.sqlite.bz2 > /tmp/yums3_primary.sqlite

# Dump SQLite schema and data
sqlite3 /tmp/createrepo_primary.sqlite .dump > /tmp/createrepo_primary.sql
sqlite3 /tmp/yums3_primary.sqlite .dump > /tmp/yums3_primary.sql
diff -u /tmp/createrepo_primary.sql /tmp/yums3_primary.sql
```

### 4. Test with DNF

```bash
# Test createrepo_c version
dnf repoquery --repofrompath=test_createrepo,/tmp/compare/createrepo \
              --repo=test_createrepo --disablerepo='*' -a

# Test yums3 version
dnf repoquery --repofrompath=test_yums3,/tmp/compare/yums3/el9/x86_64 \
              --repo=test_yums3 --disablerepo='*' -a
```

Both should return the same package list. If yums3 returns 0 packages, there's a metadata compatibility issue.

## What to Look For

### XML Differences
- **Namespace declarations** - DNF requires proper xmlns attributes
- **Element ordering** - Should not matter but worth checking
- **Whitespace** - Usually not significant
- **Timestamps** - Will differ, ignore these
- **Checksums** - Will differ due to timestamps, ignore these

### SQLite Differences
- **Schema** - Should be identical
- **Data** - Package info should match exactly
- **Indexes** - Should be identical
- **Row order** - May differ, not significant

### DNF Behavior
- **Package count** - Must match
- **Package names** - Must match exactly
- **Dependencies** - Must be readable

## Common Issues

### Issue: DNF finds 0 packages in yums3 repo

**Possible causes:**
1. Missing namespace declarations in repomd.xml
2. Incorrect SQLite database format
3. Mismatched checksums in repomd.xml
4. Missing or corrupted metadata files

**Debug steps:**
```bash
# Check if repomd.xml is valid
xmllint --noout /tmp/compare/yums3/el9/x86_64/repodata/repomd.xml

# Check if primary.xml is valid
gunzip -c /tmp/compare/yums3/el9/x86_64/repodata/*-primary.xml.gz | xmllint --noout -

# Check SQLite database
sqlite3 /tmp/yums3_primary.sqlite "SELECT COUNT(*) FROM packages;"

# Enable DNF debug logging
dnf --verbose repoquery --repofrompath=test,/tmp/compare/yums3/el9/x86_64 \
    --repo=test --disablerepo='*' -a
```

### Issue: Checksums don't match

This is expected if timestamps differ. The important thing is that the *structure* and *content* match, not the exact checksums.

### Issue: Namespace differences

createrepo_c uses:
```xml
<repomd xmlns="http://linux.duke.edu/metadata/repo" xmlns:rpm="http://linux.duke.edu/metadata/rpm">
```

yums3 must use the same format. Check the repomd.xml generation code.

## Next Steps

Once you identify the specific differences:

1. Update yums3 metadata generation to match createrepo_c format
2. Test with DNF to verify compatibility
3. Run `createrepo_c --update` on yums3 repo to see what it changes
4. Iterate until DNF accepts yums3 metadata

The local storage backend makes this iteration cycle much faster since you don't need S3 credentials or network access.
